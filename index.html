<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nebulo IoT - Smart Irrigation System</title>

    <link rel="icon" type="image/png" href="NEBULO_21-removebg-preview.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <link rel="stylesheet" href="style.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        /* --- 1. DEFINISI WARNA --- */
        :root {
            --accent: #00e676;        
            --bg: #121212;            
            --card: #1e1e1e;          
            --text: #ffffff;          
            --text-muted: #b0b0b0;   
            --border: #333333;        
            --input-bg: #2d2d2d;
            --navbar-bg: #000000;
        }

        body.light-mode {
            --accent: #00a152; --bg: #f4f6f8; --card: #ffffff; --text: #333333; --text-muted: #666666; --border: #ddd; --input-bg: #ffffff; --navbar-bg: #ffffff;
        }

        body { 
            background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; 
            display: flex; flex-direction: column; min-height: 100vh; 
            transition: background 0.3s, color 0.3s; overflow-x: hidden;
        }

        /* --- 2. PRELOADER --- */
        #preloader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000000; z-index: 999999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s ease-out, visibility 0.8s;
        }
        .loader {
            width: fit-content; font-size: 25px; font-family: monospace; line-height: 1.4; font-weight: bold;
            --c: no-repeat linear-gradient(#ffffff 0 0); 
            background: var(--c),var(--c),var(--c),var(--c),var(--c),var(--c),var(--c);
            background-size: calc(1ch + 1px) 100%; border-bottom: 10px solid #0000; 
            position: relative; animation: l8-0 3s infinite linear; clip-path: inset(-20px 0);
        }
        .loader::before { content:"Loading..."; color: white; }
        .loader::after {
            content: ""; position: absolute; width: 10px; height: 20px; background: var(--accent); 
            left: -10px; bottom: 100%; animation: l8-1 3s infinite linear;
        }
        @keyframes l8-0{ 0%,12.5% {background-position: calc(0*100%/6) 0,calc(1*100%/6) 0,calc(2*100%/6) 0,calc(3*100%/6) 0,calc(4*100%/6) 0,calc(5*100%/6) 0,calc(6*100%/6) 0} 100% {background-position: calc(0*100%/6) 40px,calc(1*100%/6) 40px,calc(2*100%/6) 40px,calc(3*100%/6) 40px,calc(4*100%/6) 40px,calc(5*100%/6) 40px,calc(6*100%/6) 40px} }
        @keyframes l8-1{ 100% {left:115%} }
        .preloader-hide { opacity: 0; visibility: hidden; }

        /* --- 3. WALLPAPER --- */
        .bg-wallpaper {
            background-color: #121212;
            background-image: linear-gradient(rgba(0, 0, 0, 0.75), rgba(0, 0, 0, 0.75)), url('alexandre-debieve1-FO7JIlwjOtU-unsplash (2).jpg');
            background-size: cover; background-position: center; background-attachment: scroll; 
        }
        @media (min-width: 768px) { .bg-wallpaper { background-attachment: fixed; } }

        /* --- 4. LANDING & LOGIN --- */
        .landing-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; color: #ffffff; z-index: 10000; overflow-y: auto; display: flex; flex-direction: column; }
        .landing-header { padding: 15px 20px; display: flex; justify-content: center; align-items: center; gap: 15px; background: rgba(0, 0, 0, 0.9); border-bottom: 1px solid rgba(255,255,255,0.1); position: sticky; top: 0; z-index: 100; }
        .landing-hero { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px 20px; min-height: 80vh; }
        .landing-text { font-size: 1.2rem; line-height: 1.6; max-width: 700px; margin-bottom: 40px; color: #e0e0e0; font-weight: 300; text-shadow: 0 1px 3px rgba(0,0,0,0.8); }
        .btn-get-started { background: #00e676; color: white; border: none; padding: 15px 50px; font-size: 1.2rem; font-weight: bold; border-radius: 50px; box-shadow: 0 4px 15px rgba(0, 230, 118, 0.4); transition: transform 0.2s; text-decoration: none; cursor: pointer; }
        .btn-get-started:hover { transform: scale(1.05); color: white; }
        .landing-info-section { background-color: #121212; padding: 50px 20px; border-top: 1px solid #333; }
        .info-card { background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 15px; padding: 25px; height: 100%; }

        .login-wrap { position: fixed; top:0; left:0; width:100%; height:100%; z-index: 8888; display: flex; align-items: center; justify-content: center; }
        
        .glass-box { 
            background: rgba(18, 18, 18, 0.95); 
            border: 1px solid rgba(0, 230, 118, 0.5); 
            padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; 
            text-align: center; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); 
            animation: holographicEntry 0.8s cubic-bezier(0.23, 1, 0.32, 1);
            
            /* TRANSISI TINGGI HALUS (Penting untuk efek saat kolom rahasia muncul) */
            transition: height 0.4s ease, padding 0.4s ease;
            overflow: hidden; /* Mencegah konten tumpah saat animasi */
        }
        
        .glass-box:hover { animation: float 4s ease-in-out infinite; }
        @keyframes holographicEntry { 0% { transform: scale(0.5) translateY(50px); opacity: 0; filter: blur(10px); } 100% { transform: scale(1) translateY(0); opacity: 1; filter: blur(0); } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

        .form-control { background-color: var(--input-bg) !important; color: var(--text) !important; border: 1px solid var(--border) !important; transition: all 0.3s ease; }
        .form-control:focus { transform: scale(1.05); border-color: var(--accent) !important; box-shadow: 0 0 15px rgba(0, 230, 118, 0.4); }
        .hidden { display: none !important; }

        /* Dashboard */
        .my-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 20px; color: var(--text); }
        .theme-toggle { cursor: pointer; border: 1px solid var(--border); background: var(--card); color: var(--text); padding: 5px 12px; border-radius: 20px; font-size: 14px; }
        .navbar { background: var(--navbar-bg); border-bottom: 2px solid var(--accent); }
        .weather-icon { font-size: 2.5rem; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="preloader">
        <div class="loader"></div>
        <p style="color: #666; margin-top: 30px; font-size: 0.9rem;">Menghubungkan ke Nebulo Server...</p>
    </div>

    <div id="landing-page" class="landing-wrap bg-wallpaper">
        <div class="landing-header">
            <img src="NEBULO_21-removebg-preview.png" alt="Icon" height="40">
            <img src="NEBULOText21-removebg-preview.png" alt="Text" height="35">
        </div>
        <div class="landing-hero animate__animated animate__fadeIn">
            <p class="landing-text">Klik ‚ÄúGet Started‚Äù untuk memonitor kelembapan tanah, cuaca, dan mengontrol irigasi tanaman TOGA Anda dari mana saja secara real-time.</p>
            <button onclick="goToLogin()" class="btn-get-started animate__animated animate__pulse animate__infinite">GET STARTED <i class="fas fa-arrow-right ms-2"></i></button>
            <div class="mt-5 text-muted small animate__animated animate__fadeInUp animate__delay-1s"><i class="fas fa-chevron-down"></i> Scroll ke bawah untuk Info <i class="fas fa-chevron-down"></i></div>
        </div>
        <div class="landing-info-section">
            <div class="container">
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="info-card">
                            <h4 style="color: #00e676; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 20px;"><i class="fas fa-users me-2"></i>Tim Pengembang</h4>
                            <ul style="list-style: none; padding: 0;">
                                <li class="mb-3"><div class="fw-bold" style="color:white;">Gregorius Rheza Eka Kurniawan</div><div class="small" style="color:#b0b0b0;">N.I.M 4.31.23.3.10</div></li>
                                <li class="mb-3"><div class="fw-bold" style="color:white;">Salsabila</div><div class="small" style="color:#b0b0b0;">N.I.M 4.31.23.3.20</div></li>
                                <li class="mb-3"><div class="fw-bold" style="color:white;">Sri Whyuni</div><div class="small" style="color:#b0b0b0;">N.I.M 4.31.23.3.21</div></li>
                            </ul>
                            <p class="small mt-3 pt-3 border-top border-secondary" style="color:#b0b0b0; text-align: justify;">Sistem Irigasi Presisi Tanaman TOGA Berbasis IoT dengan Algoritma Adaptive-Climate dan Web Monitoring Real-Time.</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-card text-center d-flex flex-column justify-content-center align-items-center">
                            <h4 style="color: #00e676; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 20px; width:100%;"><i class="fas fa-handshake me-2"></i>Mitra Pengembang</h4>
                            <img src="https://web.polines.ac.id/wp-content/uploads/2022/01/Logo-Polines-96dpi-200px.png" alt="Logo Polines" style="height: 80px; margin-bottom: 20px;">
                            <h5 class="fw-bold" style="color:white;">Politeknik Negeri Semarang</h5>
                            <div class="mt-4"><a href="mailto:sekretariat@polines.ac.id" style="text-decoration: none; color: #00e676; font-size:1.1rem;"><i class="fas fa-envelope me-2"></i> sekretariat@polines.ac.id</a></div>
                            <div class="mt-3"><a href="https://web.polines.ac.id/id/" target="_blank" class="btn btn-sm btn-outline-light rounded-pill px-4"><i class="fas fa-globe me-2"></i> Kunjungi Website</a></div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-5 small" style="color:#666;">&copy; 2024 Nebulo IoT Project.</div>
            </div>
        </div>
    </div>

    <div id="login-screen" class="login-wrap bg-wallpaper hidden">
        <div class="glass-box">
            <img src="NEBULO_21-removebg-preview.png" alt="Logo Nebulo" style="height: 100px; margin-bottom: 15px;">
            <div style="margin-bottom: 30px;"><img src="NEBULOText21-removebg-preview.png" alt="Nebulo Text" style="height: 60px; display: block; margin: 0 auto;"></div>
            
            <div id="auth-box-content">
                <h5 id="form-title" class="mb-4" style="color: #ffffff;">Login Admin</h5>
                <input type="email" id="input-email" class="form-control mb-3 text-center" placeholder="Masukkan Email Anda">
                <input type="password" id="input-pass" class="form-control mb-3 text-center" placeholder="Masukkan Password">
                
                <div id="secret-code-area" class="hidden">
                    <input type="text" id="input-code" class="form-control mb-3 text-center" placeholder="Kode Akses Tim" style="border-color: var(--accent);">
                    <small class="text-muted d-block mb-3">*Minta kode ke Ketua Tim</small>
                </div>
                
                <button id="btn-action" onclick="handleAuth()" class="btn btn-success w-100 fw-bold" style="background:var(--accent); color: white; border:none;">MASUK DASHBOARD</button>
                
                <div class="mt-3">
                    <span id="text-switch" style="color: #b0b0b0; font-size: 0.9rem;">Belum punya akun?</span>
                    <button onclick="toggleAuthMode()" class="btn btn-sm btn-link p-0 ms-1" style="color: var(--accent); text-decoration: none; font-weight: bold;"><span id="btn-switch-text">Daftar</span></button>
                </div>
            </div>

            <button onclick="backToHome()" class="btn btn-sm btn-link mt-3" style="color: #cccccc; text-decoration: none;">&larr; Kembali</button>
            <p id="login-error" class="text-danger mt-3 small hidden">Gagal!</p>
        </div>
    </div>

    <div id="main-app" class="hidden" style="flex:1; display:flex; flex-direction:column;">
        <nav class="navbar navbar-dark sticky-top">
            <div class="container d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-3">
                    <div class="navbar-brand d-flex align-items-center gap-2 m-0">
                        <img src="NEBULO_21-removebg-preview.png" alt="Logo Icon" height="40">
                        <img src="NEBULOText21-removebg-preview.png" alt="Logo Text" height="35"> 
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <button onclick="toggleTheme()" class="theme-toggle" title="Ganti Mode"><i class="fas fa-adjust"></i></button>
                    <div class="d-flex align-items-center px-2 py-1 rounded" style="background: rgba(255,255,255,0.05); border: 1px solid var(--border);">
                        <i class="fas fa-user-circle me-2" style="color:var(--accent)"></i>
                        <span id="user-email-display" style="font-size: 12px; font-weight: 500; max-width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Loading...</span>
                    </div>
                    <button onclick="handleLogout()" class="btn btn-sm btn-outline-danger rounded-pill px-3" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </nav>

        <div class="container mt-4 mb-5" style="flex: 1;">
            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="my-card h-100 d-flex align-items-center">
                        <div class="me-4 text-center" style="min-width: 80px;">
                            <div id="weather-icon" class="weather-icon" style="color: #ffb300;"><i class="fas fa-sun"></i></div>
                            <div id="weather-text" class="small fw-bold" style="color:var(--text-muted)">Cerah</div>
                        </div>
                        <div class="flex-grow-1">
                            <h6 style="color:var(--text)">PREDIKSI CUACA (BMP280)</h6>
                            <div class="d-flex justify-content-between align-items-end">
                                <div><span class="small" style="color:var(--text-muted)">Tekanan:</span><br><span id="val-pressure" class="h4" style="color:var(--accent)">--</span> <span class="small">hPa</span></div>
                                <div class="text-end"><span class="small" style="color:var(--text-muted)">Ketinggian:</span><br><span id="val-altitude" class="h5">--</span> <span class="small">mdpl</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="my-card h-100 d-flex flex-column justify-content-center">
                        <div class="d-flex justify-content-between mb-2"><span style="color:var(--text-muted)"><i class="fas fa-clock me-2"></i>Terakhir Update:</span><span id="last-update" class="fw-bold" style="color:var(--text)">--:--:--</span></div>
                        <div class="d-flex justify-content-between mb-2"><span style="color:var(--text-muted)"><i class="fas fa-wifi me-2"></i>Status Koneksi:</span><span id="conn-status" class="badge bg-success">Online</span></div>
                        <div class="mt-2"><button onclick="downloadCSV()" class="btn btn-sm w-100 btn-outline-primary"><i class="fas fa-file-download me-2"></i> Download Laporan (.CSV)</button></div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-md-5">
                    <div class="my-card d-flex justify-content-around align-items-center text-center">
                        <div><h6 style="color:var(--text-muted)">SUHU (C)</h6><div class="h2 text-warning"><span id="val-temp">--</span>¬∞</div></div>
                        <div style="border-left:1px solid var(--border); height:50px;"></div>
                        <div><h6 style="color:var(--text-muted)">LEMBAB (%)</h6><div class="h2 text-info"><span id="val-humid">--</span>%</div></div>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="my-card d-flex align-items-center justify-content-between p-3">
                        <div>
                            <h6 style="color:var(--text-muted)" class="mb-1">POMPA UTAMA</h6>
                            <span id="label-mode" class="badge bg-secondary">--</span>
                            <span id="label-pump" class="badge bg-danger ms-1" style="color:white;">--</span>
                        </div>
                        <div class="btn-group">
                            <button onclick="setMode('AUTO')" class="btn btn-sm btn-outline-info">AUTO</button>
                            <button onclick="setPump('ON')" class="btn btn-sm btn-outline-success">MANUAL ON</button>
                            <button onclick="setPump('OFF')" class="btn btn-sm btn-outline-danger">MANUAL OFF</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex align-items-center mb-3">
                <h5 class="m-0 me-3" style="color:var(--text)">Pilih Tanaman:</h5>
                <ul class="nav nav-pills plant-nav" id="plantTabs"><li class="nav-item"><button class="nav-link active">Loading...</button></li></ul>
            </div>

            <div id="plantContentArea">
                <div class="my-card text-center" style="color:var(--text-muted)">Menunggu data dari Firebase...</div>
            </div>

            <div class="row mt-4">
                <div class="col-12">
                    <div class="wifi-container">
                        <h3>üì° Jaringan Tersedia</h3>
                        <ul id="wifiList" class="wifi-list"><li class="loading">Menunggu data scan dari ESP32...</li></ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-footer" style="background:var(--navbar-bg); padding:20px; text-align:center; border-top:1px solid var(--border);">
            <p class="small mb-0" style="color:var(--text-muted)">Nebulo IoT - Hosted on Cloudflare Pages</p>
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyAlpvH2xthL3jYVvP9xO7UVDMo9T-Cahyc",
          authDomain: "nebulo-iot.firebaseapp.com",
          databaseURL: "https://nebulo-iot-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "nebulo-iot",
          storageBucket: "nebulo-iot.firebasestorage.app",
          messagingSenderId: "571257536216",
          appId: "1:571257536216:web:1362145abec2190a06e1ad"
        };

        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.database();
        const auth = firebase.auth();

        window.addEventListener('load', () => {
            setTimeout(() => {
                const preloader = document.getElementById('preloader');
                preloader.classList.add('preloader-hide');
                setTimeout(() => { preloader.style.display = 'none'; }, 800);
            }, 2500);
        });

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            localStorage.setItem('nebulo_theme', isLight ? 'light' : 'dark');
        }
        const savedTheme = localStorage.getItem('nebulo_theme');
        if (savedTheme === 'light') { document.body.classList.add('light-mode'); }

        function goToLogin() { document.getElementById('landing-page').classList.add('hidden'); document.getElementById('login-screen').classList.remove('hidden'); }
        function backToHome() { document.getElementById('login-screen').classList.add('hidden'); document.getElementById('landing-page').classList.remove('hidden'); }

        auth.onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('landing-page').classList.add('hidden');
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                const emailDisplay = document.getElementById('user-email-display');
                if(user.email) { emailDisplay.innerText = user.email; } else { emailDisplay.innerText = "User"; }
                startApp();
            } else {
                if(!document.getElementById('main-app').classList.contains('hidden')) {
                     document.getElementById('main-app').classList.add('hidden');
                     document.getElementById('landing-page').classList.remove('hidden');
                }
                if(document.getElementById('landing-page').classList.contains('hidden') && 
                   document.getElementById('login-screen').classList.contains('hidden')) {
                     document.getElementById('landing-page').classList.remove('hidden');
                }
            }
        });

        let isLoginMode = true; 
        const SECRET_CODE = "POLINES24"; 

        // --- ANIMASI TRANSISI LOGIN <-> REGISTER ---
        function toggleAuthMode() {
            const container = document.getElementById('auth-box-content');
            
            // 1. Animasi Keluar (Fade Out)
            container.classList.remove('animate__fadeIn'); // Reset animasi masuk
            container.classList.add('animate__animated', 'animate__fadeOut');

            // 2. Tunggu sebentar (0.5 detik) baru ganti text & mode
            setTimeout(() => {
                isLoginMode = !isLoginMode; // Switch logic
                
                const title = document.getElementById('form-title');
                const btn = document.getElementById('btn-action');
                const textSwitch = document.getElementById('text-switch');
                const btnSwitch = document.getElementById('btn-switch-text');
                const secretArea = document.getElementById('secret-code-area');
                const errorText = document.getElementById('login-error');

                errorText.classList.add('hidden');

                if (isLoginMode) {
                    title.innerText = "Login Admin"; btn.innerText = "MASUK DASHBOARD"; textSwitch.innerText = "Belum punya akun?"; btnSwitch.innerText = "Daftar"; secretArea.classList.add('hidden'); 
                } else {
                    title.innerText = "Daftar Akun Tim"; btn.innerText = "DAFTAR SEKARANG"; textSwitch.innerText = "Sudah punya akun?"; btnSwitch.innerText = "Login"; secretArea.classList.remove('hidden'); 
                }

                // 3. Animasi Masuk (Fade In)
                container.classList.remove('animate__fadeOut');
                container.classList.add('animate__fadeIn');
            }, 500); // Waktu jeda sesuai durasi animasi animate.css
        }

        function handleAuth() {
            const email = document.getElementById('input-email').value;
            const pass = document.getElementById('input-pass').value;
            const errorText = document.getElementById('login-error');
            const btn = document.getElementById('btn-action');

            if(!email || !pass) {
                errorText.innerText = "Email dan Password tidak boleh kosong!"; errorText.classList.remove('hidden'); return;
            }
            if (!isLoginMode) {
                const code = document.getElementById('input-code').value;
                if (code !== SECRET_CODE) { errorText.innerText = "Kode Akses Tim SALAH!"; errorText.classList.remove('hidden'); return; }
            }
            btn.innerText = "Memproses..."; btn.disabled = true;

            if (isLoginMode) {
                auth.signInWithEmailAndPassword(email, pass).then((userCredential) => { errorText.classList.add('hidden'); }).catch((error) => {
                    errorText.innerText = "Login Gagal: " + error.message; errorText.classList.remove('hidden'); btn.innerText = 'MASUK DASHBOARD'; btn.disabled = false;
                });
            } else {
                auth.createUserWithEmailAndPassword(email, pass).then((userCredential) => { errorText.classList.add('hidden'); alert("Registrasi Berhasil!"); }).catch((error) => {
                    errorText.innerText = "Daftar Gagal: " + error.message; errorText.classList.remove('hidden'); btn.innerText = 'DAFTAR SEKARANG'; btn.disabled = false;
                });
            }
        }

        function handleLogout() { auth.signOut().then(() => { location.reload(); }); }

        let plantsData = [
            { id: 1, name: 'Temulawak', slot: 'w1', min: 60, desc: 'Tanaman Rimpang / Butuh Air Sedang' },
            { id: 2, name: 'Lidah Buaya', slot: 'w2', min: 30, desc: 'Tanaman Sukulen / Hemat Air' }
        ]; 
        let activePlantIndex = 0; let myChart = null; let chartDataBuffer = []; 

        function startApp() {
            db.ref('sensor_logs').limitToLast(1).on('value', (snap) => {
                const data = snap.val();
                if(data) {
                    const key = Object.keys(data)[0]; const last = data[key];
                    document.getElementById('val-temp').innerText = last.temp || 0;
                    document.getElementById('val-humid').innerText = last.humid || 0;
                    const press = last.pressure || 1013; const alt = last.altitude || 0;
                    document.getElementById('val-pressure').innerText = press;
                    document.getElementById('val-altitude').innerText = alt;
                    updateWeatherUI(press);
                    const time = new Date().toLocaleTimeString();
                    document.getElementById('last-update').innerText = time;
                    renderPlantContent(last);
                    setTimeout(() => { initChart(plantsData[activePlantIndex].slot); }, 100);
                }
            });
            db.ref('settings').on('value', (snap) => {
                const s = snap.val() || {};
                const mode = s.control_mode || 'MANUAL'; const pump = s.pump_status || 'OFF';
                document.getElementById('label-mode').innerText = mode;
                document.getElementById('label-pump').innerText = pump;
                const pumpBadge = document.getElementById('label-pump');
                pumpBadge.className = (pump === 'ON') ? "badge bg-success ms-1" : "badge bg-danger ms-1";
            });
            renderTabs();
        }

        function updateWeatherUI(pressure) {
            const icon = document.getElementById('weather-icon'); const text = document.getElementById('weather-text');
            if(pressure < 1005) { icon.innerHTML = '<i class="fas fa-cloud-showers-heavy"></i>'; icon.style.color = "#4fc3f7"; text.innerText = "Mendung/Hujan"; } 
            else if (pressure >= 1005 && pressure < 1015) { icon.innerHTML = '<i class="fas fa-cloud-sun"></i>'; icon.style.color = "#ffb300"; text.innerText = "Berawan"; } 
            else { icon.innerHTML = '<i class="fas fa-sun"></i>'; icon.style.color = "#ffeb3b"; text.innerText = "Cerah"; }
        }

        function downloadCSV() {
            if(chartDataBuffer.length === 0) { alert("Belum ada data."); return; }
            let csvContent = "data:text/csv;charset=utf-8,Waktu,Kelembaban Tanah (%)\n";
            chartDataBuffer.forEach(function(row) { csvContent += row.time + "," + row.value + "\n"; });
            var encodedUri = encodeURI(csvContent); var link = document.createElement("a");
            link.setAttribute("href", encodedUri); link.setAttribute("download", "Laporan_" + plantsData[activePlantIndex].name + ".csv");
            document.body.appendChild(link); link.click();
        }

        function renderTabs() {
            const ul = document.getElementById('plantTabs'); ul.innerHTML = '';
            plantsData.forEach((p, index) => {
                const activeClass = index === 0 ? 'active' : '';
                ul.innerHTML += `<li class="nav-item"><button onclick="switchTab(${index})" class="nav-link ${activeClass}" id="btn-tab-${index}">${p.name}</button></li>`;
            });
        }
        function switchTab(index) {
            activePlantIndex = index;
            document.querySelectorAll('.plant-nav .nav-link').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-tab-${index}`).classList.add('active');
            db.ref('sensor_logs').limitToLast(1).once('value').then(snap => {
                const data = snap.val(); if(data) { const key = Object.keys(data)[0]; renderPlantContent(data[key]); setTimeout(() => { initChart(plantsData[index].slot); }, 100); }
            });
        }

        function renderPlantContent(sensorData) {
            const p = plantsData[activePlantIndex]; const val = sensorData[p.slot] || 0;
            const status = val < p.min ? "KERING" : "AMAN"; const color = status === "KERING" ? "#ff4444" : "#00e676"; 
            let tips = status === "KERING" ? "‚ö†Ô∏è <b>PERINGATAN:</b> Tanah kering! Pompa akan menyala otomatis." : "‚úÖ <b>OPTIMAL:</b> Kondisi tanah bagus.";
            
            const html = `
                <div class="row g-4 fade-in">
                    <div class="col-md-4">
                        <div class="my-card">
                            <h4 style="color:var(--accent)">${p.name}</h4><p class="small mb-3" style="color:var(--text-muted)">${p.desc}</p>
                            <div class="text-center py-2 border-bottom border-secondary"><div style="font-size: 4rem; font-weight: bold; color: ${color}">${val}%</div><div class="badge bg-secondary mt-1">Batas Kering: < ${p.min}%</div></div>
                            <div class="mt-3"><h6 class="text-info mb-2">STATUS: <b>${status}</b></h6></div><div class="alert mt-2 p-2 small" style="background: rgba(255,255,255,0.05); color: var(--text-muted); border: 1px solid var(--border);">${tips}</div>
                        </div>
                    </div>
                    <div class="col-md-8"><div class="my-card"><h5 class="mb-3" style="color:var(--text-muted)">Grafik Real-time (${p.name})</h5><div style="height: 320px;"><canvas id="mainChart"></canvas></div></div></div>
                </div>
            `;
            document.getElementById('plantContentArea').innerHTML = html;
        }

        function initChart(slotKey) {
            const ctx = document.getElementById('mainChart'); if(!ctx) return; if(myChart) { myChart.destroy(); }
            db.ref('sensor_logs').limitToLast(20).once('value', (snap) => {
                const raw = snap.val(); if(!raw) return;
                const labels = []; const dataPoints = []; chartDataBuffer = []; 
                Object.keys(raw).forEach(k => {
                    const r = raw[k]; let timeLabel = r.timestamp ? r.timestamp.substring(11, 16) : "now"; 
                    labels.push(timeLabel); dataPoints.push(r[slotKey]); chartDataBuffer.push({time: timeLabel, value: r[slotKey]});
                });
                const styles = getComputedStyle(document.body); const accentColor = styles.getPropertyValue('--accent').trim(); const gridColor = styles.getPropertyValue('--border').trim();
                myChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: labels, datasets: [{ label: 'Kelembaban (%)', data: dataPoints, borderColor: accentColor, backgroundColor: accentColor + '20', borderWidth: 2, fill: true, tension: 0.4 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { grid: { color: gridColor }, max: 100 }, x: { display: false } }, plugins: { legend: { display: false } }, animation: false }
                });
            });
        }
    </script>
    <script src="script.js"></script>
</body>
</html>
